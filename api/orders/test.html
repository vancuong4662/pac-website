<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orders API Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .section h3 { margin-top: 0; color: #333; background: #f8f9fa; padding: 10px; margin: -20px -20px 15px -20px; border-radius: 8px 8px 0 0; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; margin-bottom: 10px; }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        button.warning { background: #ffc107; color: #212529; }
        button.warning:hover { background: #e0a800; }
        .response { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px; border-left: 4px solid #007bff; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        .success { border-left-color: #28a745; background: #d4edda; }
        pre { margin: 0; white-space: pre-wrap; word-break: break-word; }
        .auth-status { padding: 10px; margin-bottom: 20px; border-radius: 4px; text-align: center; font-weight: bold; }
        .auth-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .auth-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .quick-actions { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .order-summary { background: #e9ecef; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .cart-preview { background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border: 1px solid #ffeaa7; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .status-badge { padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .payment-pending { background: #fff3cd; color: #856404; }
        .payment-paid { background: #d4edda; color: #155724; }
        .payment-failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Orders API Test Interface</h1>
        
        <div id="authStatus" class="auth-status"></div>
        
        <div class="quick-actions">
            <button onclick="checkAuth()">Check Auth</button>
            <button onclick="loadCartPreview()">Preview Cart</button>
            <button onclick="loadMyOrders()">My Orders</button>
            <button onclick="setupTestData()" class="warning">Setup Test Data</button>
        </div>

        <!-- Cart Preview -->
        <div id="cartPreview" class="cart-preview" style="display:none;">
            <h4>üõí Current Cart Preview</h4>
            <div id="cartPreviewContent"></div>
            <button onclick="createOrderFromCart()" class="success">Create Order from Cart</button>
        </div>

        <!-- Create Order -->
        <div class="section">
            <h3>‚ûï Create Order (POST /api/orders/create.php)</h3>
            <p><strong>Note:</strong> This will create an order from your current cart items.</p>
            <div class="form-group">
                <label>Payment Method:</label>
                <select id="createPaymentMethod">
                    <option value="bank_transfer">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                    <option value="credit_card">Th·∫ª t√≠n d·ª•ng</option>
                    <option value="e_wallet">V√≠ ƒëi·ªán t·ª≠</option>
                    <option value="cash">Ti·ªÅn m·∫∑t</option>
                </select>
            </div>
            <div class="form-group">
                <label>Notes (Optional):</label>
                <textarea id="createNotes" rows="3" placeholder="Ghi ch√∫ cho ƒë∆°n h√†ng..."></textarea>
            </div>
            <button onclick="createOrder()" class="success">Create Order</button>
            <div id="createOrderResponse" class="response" style="display:none;"></div>
        </div>

        <!-- List Orders -->
        <div class="section">
            <h3>üìã List Orders (GET /api/orders/list.php)</h3>
            <div class="grid">
                <div class="form-group">
                    <label>Page:</label>
                    <input type="number" id="listPage" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Limit:</label>
                    <input type="number" id="listLimit" value="10" min="5" max="50">
                </div>
                <div class="form-group">
                    <label>Status:</label>
                    <select id="listStatus">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Status:</label>
                    <select id="listPaymentStatus">
                        <option value="">All</option>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
            </div>
            <button onclick="listOrders()">Load Orders</button>
            <div id="listOrdersResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Order Detail -->
        <div class="section">
            <h3>üîç Order Detail (GET /api/orders/detail.php)</h3>
            <div class="form-group">
                <label>Order ID:</label>
                <input type="number" id="detailOrderId" value="" min="1" placeholder="Enter order ID">
            </div>
            <button onclick="getOrderDetail()">Get Order Detail</button>
            <div id="orderDetailResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Payment Processing -->
        <div class="section">
            <h3>üí≥ Process Payment (POST /api/orders/payment.php)</h3>
            <div class="grid">
                <div class="form-group">
                    <label>Order ID:</label>
                    <input type="number" id="paymentOrderId" value="" min="1" placeholder="Enter order ID">
                </div>
                <div class="form-group">
                    <label>Payment Method:</label>
                    <select id="paymentMethod">
                        <option value="bank_transfer">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                        <option value="credit_card">Th·∫ª t√≠n d·ª•ng</option>
                        <option value="e_wallet">V√≠ ƒëi·ªán t·ª≠</option>
                        <option value="cash">Ti·ªÅn m·∫∑t</option>
                    </select>
                </div>
            </div>
            <button onclick="processPayment()" class="success">Process Payment</button>
            <div id="paymentResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Process Purchase Items -->
        <div class="section">
            <h3>üéÅ Process Purchase Items (POST /api/orders/process-purchase.php)</h3>
            <p><strong>Note:</strong> Manually process purchase items for paid orders.</p>
            <div class="grid">
                <div class="form-group">
                    <label>Order ID:</label>
                    <input type="number" id="processOrderId" value="" min="1" placeholder="Enter order ID">
                </div>
                <div class="form-group">
                    <label>Force Process:</label>
                    <select id="forceProcess">
                        <option value="false">No - Check order status</option>
                        <option value="true">Yes - Force process</option>
                    </select>
                </div>
            </div>
            <button onclick="processPurchaseItems()" class="warning">Process Purchase Items</button>
            <div id="processPurchaseResponse" class="response" style="display:none;"></div>
        </div>

        <!-- Orders Summary -->
        <div id="ordersSummary" class="order-summary" style="display:none;">
            <h4>üìä Orders Summary</h4>
            <div id="ordersSummaryContent"></div>
        </div>
    </div>

    <script>
        // Base API URL
        const API_BASE = '/api/orders';
        
        // Check authentication status
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/verify-session.php');
                const data = await response.json();
                
                const authStatus = document.getElementById('authStatus');
                if (data.success) {
                    authStatus.className = 'auth-status auth-success';
                    authStatus.textContent = `‚úÖ Authenticated as: ${data.data.name} (${data.data.email})`;
                } else {
                    authStatus.className = 'auth-status auth-error';
                    authStatus.textContent = '‚ùå Not authenticated. Please login first.';
                }
            } catch (error) {
                const authStatus = document.getElementById('authStatus');
                authStatus.className = 'auth-status auth-error';
                authStatus.textContent = '‚ùå Error checking authentication';
            }
        }

        // Utility function to make API calls
        async function apiCall(url, method = 'GET', data = null) {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                }
            };
            
            if (data) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            return await response.json();
        }

        // Display response
        function displayResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `response ${isError ? 'error' : 'success'}`;
            element.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            
            // Auto-fill order ID if order was created
            if (data.success && data.data && data.data.order && data.data.order.id) {
                const orderId = data.data.order.id;
                document.getElementById('detailOrderId').value = orderId;
                document.getElementById('paymentOrderId').value = orderId;
                document.getElementById('processOrderId').value = orderId;
            }
        }

        // Load cart preview
        async function loadCartPreview() {
            try {
                const data = await apiCall('/api/cart/get.php');
                const previewDiv = document.getElementById('cartPreview');
                const contentDiv = document.getElementById('cartPreviewContent');
                
                if (data.success && data.data.items.length > 0) {
                    let html = `<p><strong>Items in cart:</strong> ${data.data.summary.total_items}</p>`;
                    html += `<p><strong>Total:</strong> ${data.data.summary.total_formatted}</p>`;
                    html += '<ul>';
                    data.data.items.forEach(item => {
                        html += `<li>${item.name} x${item.quantity} - ${item.subtotal_formatted}</li>`;
                    });
                    html += '</ul>';
                    contentDiv.innerHTML = html;
                    previewDiv.style.display = 'block';
                } else {
                    contentDiv.innerHTML = '<p>Cart is empty. Add some products first.</p>';
                    previewDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading cart:', error);
            }
        }

        // Create Order
        async function createOrder() {
            const paymentMethod = document.getElementById('createPaymentMethod').value;
            const notes = document.getElementById('createNotes').value;
            
            try {
                const data = await apiCall(`${API_BASE}/create.php`, 'POST', {
                    payment_method: paymentMethod,
                    notes: notes
                });
                displayResponse('createOrderResponse', data, !data.success);
                
                // Refresh cart preview after order creation
                if (data.success) {
                    setTimeout(() => {
                        loadCartPreview();
                        loadMyOrders();
                    }, 500);
                }
            } catch (error) {
                displayResponse('createOrderResponse', {error: error.message}, true);
            }
        }

        // List Orders
        async function listOrders() {
            const page = document.getElementById('listPage').value;
            const limit = document.getElementById('listLimit').value;
            const status = document.getElementById('listStatus').value;
            const paymentStatus = document.getElementById('listPaymentStatus').value;
            
            const params = new URLSearchParams();
            if (page) params.append('page', page);
            if (limit) params.append('limit', limit);
            if (status) params.append('status', status);
            if (paymentStatus) params.append('payment_status', paymentStatus);
            
            try {
                const data = await apiCall(`${API_BASE}/list.php?${params.toString()}`);
                displayResponse('listOrdersResponse', data, !data.success);
                
                // Show orders summary
                if (data.success) {
                    updateOrdersSummary(data.data);
                }
            } catch (error) {
                displayResponse('listOrdersResponse', {error: error.message}, true);
            }
        }

        // Get Order Detail
        async function getOrderDetail() {
            const orderId = document.getElementById('detailOrderId').value;
            
            if (!orderId) {
                alert('Please enter Order ID');
                return;
            }
            
            try {
                const data = await apiCall(`${API_BASE}/detail.php?id=${orderId}`);
                displayResponse('orderDetailResponse', data, !data.success);
            } catch (error) {
                displayResponse('orderDetailResponse', {error: error.message}, true);
            }
        }

        // Process Payment
        async function processPayment() {
            const orderId = document.getElementById('paymentOrderId').value;
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!orderId) {
                alert('Please enter Order ID');
                return;
            }
            
            try {
                const data = await apiCall(`${API_BASE}/payment.php`, 'POST', {
                    order_id: parseInt(orderId),
                    payment_method: paymentMethod,
                    payment_data: {} // Mock payment data
                });
                displayResponse('paymentResponse', data, !data.success);
                
                // Auto-fill other forms with this order ID
                if (data.success) {
                    document.getElementById('detailOrderId').value = orderId;
                    document.getElementById('processOrderId').value = orderId;
                }
            } catch (error) {
                displayResponse('paymentResponse', {error: error.message}, true);
            }
        }

        // Process Purchase Items
        async function processPurchaseItems() {
            const orderId = document.getElementById('processOrderId').value;
            const force = document.getElementById('forceProcess').value === 'true';
            
            if (!orderId) {
                alert('Please enter Order ID');
                return;
            }
            
            try {
                const data = await apiCall(`${API_BASE}/process-purchase.php`, 'POST', {
                    order_id: parseInt(orderId),
                    force: force
                });
                displayResponse('processPurchaseResponse', data, !data.success);
            } catch (error) {
                displayResponse('processPurchaseResponse', {error: error.message}, true);
            }
        }

        // Update orders summary
        function updateOrdersSummary(data) {
            const summaryDiv = document.getElementById('ordersSummary');
            const contentDiv = document.getElementById('ordersSummaryContent');
            
            if (data.orders && data.orders.length > 0) {
                let html = `<p><strong>Total Orders:</strong> ${data.pagination.total}</p>`;
                html += `<p><strong>Showing:</strong> Page ${data.pagination.current_page} of ${data.pagination.total_pages}</p>`;
                
                // Status breakdown
                const statusCount = {};
                const paymentCount = {};
                let totalAmount = 0;
                
                data.orders.forEach(order => {
                    statusCount[order.status] = (statusCount[order.status] || 0) + 1;
                    paymentCount[order.payment_status] = (paymentCount[order.payment_status] || 0) + 1;
                    totalAmount += parseFloat(order.total_amount);
                });
                
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">';
                html += '<div><strong>Status:</strong><br>';
                Object.entries(statusCount).forEach(([status, count]) => {
                    html += `<span class="status-badge status-${status}">${status}: ${count}</span> `;
                });
                html += '</div>';
                
                html += '<div><strong>Payment:</strong><br>';
                Object.entries(paymentCount).forEach(([status, count]) => {
                    html += `<span class="status-badge payment-${status}">${status}: ${count}</span> `;
                });
                html += '</div>';
                html += '</div>';
                
                html += `<p><strong>Total Value:</strong> ${totalAmount.toLocaleString('vi-VN')} VND</p>`;
                
                contentDiv.innerHTML = html;
                summaryDiv.style.display = 'block';
            } else {
                summaryDiv.style.display = 'none';
            }
        }

        // Quick actions
        function loadMyOrders() {
            listOrders();
        }

        function createOrderFromCart() {
            createOrder();
        }

        async function setupTestData() {
            // Add some products to cart first
            const products = [
                {product_id: 1, quantity: 1},
                {product_id: 2, quantity: 2}
            ];
            
            for (const product of products) {
                try {
                    await apiCall('/api/cart/add.php', 'POST', product);
                } catch (error) {
                    console.error('Error adding product:', error);
                }
            }
            
            // Refresh cart preview
            setTimeout(() => {
                loadCartPreview();
                alert('Test data added to cart. You can now create an order.');
            }, 500);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadCartPreview();
            loadMyOrders();
        });
    </script>
</body>
</html>
