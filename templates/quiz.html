<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trắc Nghiệm</title>
    <meta name="description" content="Thực hiện bài trắc nghiệm tính cách với hệ thống đánh giá chuyên nghiệp của PAC Group.">
    
    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon">
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    
    <!-- Vendor CSS -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="assets/vendor/aos/aos.css" rel="stylesheet">
    
    <!-- Main CSS -->
    <link href="assets/css/main.css?v=20112025" rel="stylesheet">
    <link href="assets/css/toastbar.css?v=20112025" rel="stylesheet">
    
    <style>
        .test-page {
            min-height: 100vh;
            background: var(--bg-light);
        }
        
        .quiz-hero {
            background: linear-gradient(135deg, var(--brand-secondary) 0%, var(--brand-primary) 100%);
            color: var(--contrast-color);
            padding: 140px 0 80px 0;
            position: relative;
            overflow: hidden;
        }
        
        .quiz-hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('assets/img/banner/banner-1024x507.png') center/cover;
            opacity: 0.1;
            z-index: 1;
        }
        
        .quiz-hero .container {
            position: relative;
            z-index: 2;
        }
        
        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 24px;
            line-height: 1.2;
            font-family: var(--heading-font);
        }
        
        .hero-subtitle {
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 40px;
            opacity: 0.95;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            font-family: var(--default-font);
        }
        
        .test-info-cards {
            margin-top: 40px;
        }
        
        .info-card {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px 15px;
            text-align: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            height: 100%;
        }
        
        .info-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px);
        }
        
        .info-icon {
            font-size: 2rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .info-number {
            font-size: 2rem;
            font-weight: 800;
            font-family: var(--heading-font);
            margin-bottom: 5px;
        }
        
        .info-name {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .info-label {
            font-size: 0.9rem;
            opacity: 0.8;
            font-weight: 500;
        }
        
        .timer-card {
            background: rgba(255, 242, 0, 0.15);
            border-color: rgba(255, 242, 0, 0.3);
        }
        
        .timer-display {
            font-size: 1.8rem;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        
        .timer-warning {
            background: rgba(255, 193, 7, 0.2) !important;
            border-color: rgba(255, 193, 7, 0.4) !important;
            animation: pulse 1.5s infinite;
        }
        
        .timer-danger {
            background: rgba(220, 53, 69, 0.2) !important;
            border-color: rgba(220, 53, 69, 0.4) !important;
            animation: flash 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes flash {
            0%, 100% { opacity: 1; }
            25%, 75% { opacity: 0.5; }
        }
        
        .test-container {
            max-width: 1400px;
            margin: 24px auto;
            padding: 0 15px;
        }
        
        .test-content {
            display: flex;
            gap: 30px;
            align-items: flex-start;
        }
        
        .test-sidebar {
            width: 350px;
            flex-shrink: 0;
            background: var(--surface-color);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(var(--brand-secondary-rgb), 0.08);
            position: sticky;
            top: 140px;
            max-height: calc(100vh - 160px);
            overflow-y: auto;
        }
        
        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--heading-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .question-minimap {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .minimap-question {
            width: 50px;
            height: 50px;
            border: 2px solid #e5e7eb;
            background: var(--surface-color);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .minimap-question:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(var(--brand-primary-rgb), 0.2);
        }
        
        .minimap-question.current {
            background: var(--brand-primary);
            border-color: var(--brand-primary);
            color: var(--contrast-color);
            transform: scale(1.1);
        }
        
        .minimap-question.answered {
            background: var(--brand-secondary);
            border-color: var(--brand-secondary);
            color: var(--contrast-color);
        }
        
        .minimap-question.answered::after {
            content: '✓';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #28a745;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .progress-section {
            margin-bottom: 25px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--default-color);
        }
        
        .progress {
            height: 12px;
            border-radius: 10px;
            background: #e5e7eb;
            overflow: hidden;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, var(--brand-primary), var(--brand-secondary));
            transition: width 0.3s ease;
        }
        
        .test-stats {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .stat-label {
            color: var(--default-color);
        }
        
        .stat-value {
            font-weight: 600;
            color: var(--heading-color);
        }
        
        .test-main {
            flex: 1;
            background: var(--surface-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 30px rgba(var(--brand-secondary-rgb), 0.08);
            min-height: 500px;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f1f3f4;
        }
        
        .question-number {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: var(--contrast-color);
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .question-type {
            background: rgba(var(--brand-accent-rgb), 0.1);
            color: var(--brand-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .question-content {
            margin-bottom: 30px;
        }
        
        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--heading-color);
            line-height: 1.6;
            margin-bottom: 25px;
        }
        
        .question-description {
            color: var(--default-color);
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .answers-section {
            margin-bottom: 40px;
        }
        
        .question-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #e5e7eb;
        }
        
        .question-group h4 {
            font-size: 1.1rem;
            color: var(--heading-color);
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .option-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .answer-option {
            background: #f8f9fa;
            border: 2px solid #e5e7eb;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .answer-option:hover {
            border-color: var(--brand-primary);
            background: rgba(var(--brand-primary-rgb), 0.05);
            transform: translateX(5px);
        }
        
        .answer-option.selected {
            border-color: var(--brand-primary);
            background: rgba(var(--brand-primary-rgb), 0.1);
            box-shadow: 0 4px 15px rgba(var(--brand-primary-rgb), 0.15);
        }
        
        .answer-option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: transparent;
            transition: background 0.3s ease;
        }
        
        .answer-option.selected::before {
            background: var(--brand-primary);
        }
        
        .answer-radio {
            display: none;
        }
        
        .answer-label {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            cursor: pointer;
            width: 100%;
        }
        
        .answer-marker {
            width: 28px;
            height: 28px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--surface-color);
            flex-shrink: 0;
            margin-top: 2px;
            transition: all 0.3s ease;
        }
        
        .answer-option.selected .answer-marker {
            border-color: var(--brand-primary);
            background: var(--brand-primary);
        }
        
        .answer-option.selected .answer-marker::after {
            content: '✓';
            color: var(--contrast-color);
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .answer-text {
            flex: 1;
            font-size: 1.1rem;
            line-height: 1.5;
            color: var(--default-color);
        }
        
        .question-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 25px;
            border-top: 2px solid #f1f3f4;
        }
        
        .btn-nav {
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-prev {
            background: #6c757d;
            color: var(--contrast-color);
        }
        
        .btn-prev:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-next {
            background: linear-gradient(135deg, var(--brand-primary), var(--brand-secondary));
            color: var(--contrast-color);
        }
        
        .btn-next:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(var(--brand-primary-rgb), 0.3);
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #5d2e8b, #713ea3);
            color: white;
            padding: 25px 30px 9px 30px;
            font-size: 1.1rem;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit i {
            color: white !important;
            margin-right: 8px;
            font-size: 1.2rem !important;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            color: white;
        }
        
        .btn-submit:hover i {
            color: white !important;
        }
        
        .btn-nav:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .test-complete {
            text-align: center;
            padding: 60px 40px;
        }
        
        .test-complete i {
            font-size: 4rem;
            color: #28a745;
            margin-bottom: 25px;
        }
        
        .test-complete h2 {
            color: var(--heading-color);
            margin-bottom: 20px;
        }
        
        .test-complete p {
            color: var(--default-color);
            font-size: 1.1rem;
            margin-bottom: 30px;
        }
        
        /* YouTube Video Player Styles */
        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }
        
        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 12px;
        }
        
        .video-status-message {
            background: rgba(var(--brand-primary-rgb), 0.05);
            border: 1px solid rgba(var(--brand-primary-rgb), 0.15);
            border-radius: 12px;
            padding: 20px;
        }
        
        /* PAC Primary Button Styles */
        .btn-pac-primary {
            background: linear-gradient(135deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
            border: none;
            color: var(--contrast-color);
            font-weight: 600;
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-pac-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-pac-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(var(--brand-primary-rgb), 0.4);
            color: var(--contrast-color);
        }
        
        .btn-pac-primary:hover::before {
            left: 100%;
        }
        
        .btn-pac-primary:active {
            transform: translateY(0);
        }
        
        #videoPlayerContainer {
            animation: fadeInUp 0.5s ease-out;
        }
        
        #viewResultsContainer {
            animation: fadeInUp 0.5s ease-out;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Mobile Responsive */
        @media (max-width: 992px) {
            .quiz-hero {
                padding: 120px 0 60px 0;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .hero-subtitle {
                font-size: 1.1rem;
            }
            
            .test-content {
                flex-direction: column;
            }
            
            .test-sidebar {
                width: 100%;
                position: static;
                max-height: none;
                order: -1;
            }
            
            .question-minimap {
                grid-template-columns: repeat(10, 1fr);
            }
            
            .minimap-question {
                width: 40px;
                height: 40px;
                font-size: 0.8rem;
            }
            
            .test-main {
                padding: 25px;
            }
            
            .question-text {
                font-size: 1.2rem;
            }
            
            .answer-text {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 768px) {
            .quiz-hero {
                padding: 100px 0 50px 0;
            }
            
            .hero-title {
                font-size: 2rem;
            }
            
            .hero-subtitle {
                font-size: 1rem;
            }
            
            .info-card {
                padding: 15px 10px;
            }
            
            .info-number, .timer-display {
                font-size: 1.5rem;
            }
            
            .test-main {
                padding: 20px;
            }
            
            .question-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .question-actions {
                flex-direction: column;
                gap: 15px;
            }
            
            .question-actions > *,
            .question-actions > div {
                width: 100%;
            }
            
            .btn-nav {
                width: 100% !important;
                justify-content: center;
                min-height: 50px;
            }
        }
        
        @media (max-width: 576px) {
            .hero-title {
                font-size: 1.8rem;
            }
            
            .question-minimap {
                grid-template-columns: repeat(5, 1fr);
            }
            
            .minimap-question {
                width: 35px;
                height: 35px;
                font-size: 0.75rem;
            }
            
            .info-number, .timer-display {
                font-size: 1.3rem;
            }
            
            /* Mobile video player adjustments */
            .video-wrapper {
                border-radius: 8px;
            }
            
            .video-wrapper iframe {
                border-radius: 8px;
            }
            
            #videoPlayerContainer p {
                font-size: 0.9rem;
                padding: 0 10px;
            }
            
            .video-status-message {
                padding: 15px;
                margin-top: 15px !important;
            }
            
            .video-status-message .fw-bold {
                font-size: 0.9rem;
            }
            
            .video-status-message small {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="test-page">
    <!-- Preloader -->
    <div id="preloader"></div>
    
    <!-- Header Section Container -->
    <div id="header-section">
        <!-- Header component will be loaded here -->
    </div>
    
    <!-- Quiz Hero Section -->
    <section class="quiz-hero">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8 mx-auto text-center">
                    <h1 class="hero-title" data-aos="fade-up">
                        Trắc Nghiệm Định Hướng Nghề Nghiệp
                    </h1>
                    <p class="hero-subtitle" data-aos="fade-up" data-aos-delay="100">
                        Khám phá tiềm năng và định hướng nghề nghiệp phù hợp với bạn thông qua bài trắc nghiệm 
                        được thiết kế dựa trên các nghiên cứu khoa học về tâm lý học nghề nghiệp.
                    </p>
                    
                    <!-- Test Info Cards -->
                    <div class="test-info-cards" data-aos="fade-up" data-aos-delay="200">
                        <div class="row g-3 justify-content-center">
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="info-card">
                                    <div class="info-icon">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-number" id="totalQuestions">20</div>
                                        <div class="info-label">Câu hỏi</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="info-card">
                                    <div class="info-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-number" id="testDuration">30</div>
                                        <div class="info-label">Phút</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="info-card">
                                    <div class="info-icon">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="info-name" id="candidateName">Người dùng</div>
                                        <div class="info-label">Thí sinh</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="info-card timer-card">
                                    <div class="info-icon">
                                        <i class="fas fa-hourglass-half"></i>
                                    </div>
                                    <div class="info-content">
                                        <div class="timer-display" id="timerDisplay">
                                            <span id="timeRemaining">30:00</span>
                                        </div>
                                        <div class="info-label">Thời gian còn lại</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Test Container -->
    <div class="test-container">
        <div class="test-content">
            <!-- Sidebar with Minimap -->
            <div class="test-sidebar" data-aos="fade-right">
                <h3 class="sidebar-title">
                    <i class="fas fa-map"></i>
                    Tổng quan trắc nghiệm
                </h3>
                
                <!-- Question Minimap -->
                <div class="question-minimap" id="questionMinimap">
                    <!-- Minimap items will be generated by JavaScript -->
                </div>
                
                <!-- Progress Section -->
                <div class="progress-section">
                    <div class="progress-info">
                        <span>Tiến độ</span>
                        <span id="progressText">0/20</span>
                    </div>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Test Stats -->
                <div class="test-stats">
                    <div class="stat-item">
                        <span class="stat-label">Đã trả lời:</span>
                        <span class="stat-value" id="answeredCount">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Còn lại:</span>
                        <span class="stat-value" id="remainingCount">20</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Thời gian đã dùng:</span>
                        <span class="stat-value" id="timeUsed">00:00</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Test Area -->
            <div class="test-main" data-aos="fade-left">
                <div id="questionContainer">
                    <!-- Questions will be loaded here by JavaScript -->
                </div>
                
                <!-- Test Complete Screen -->
                <div id="testCompleteScreen" class="test-complete" style="display: none;">
                    <!-- Initial completion message -->
                    <div id="completionMessage">
                        <i class="fas fa-check-circle"></i>
                        <h2>Hoàn thành trắc nghiệm!</h2>
                        <p>Bạn đã hoàn thành tất cả câu hỏi. Kết quả sẽ được xử lý và gửi về cho bạn sớm nhất.</p>
                        <button class="btn btn-submit" id="submitTestBtn" onclick="submitTest()">
                            <i class="fas fa-paper-plane"></i>
                            Nộp bài trắc nghiệm
                        </button>
                    </div>
                    
                    <!-- YouTube Video Player (Hidden by default) -->
                    <div id="videoPlayerContainer" style="display: none; margin-top: 30px;">
                        <div class="video-status-message mt-3">
                            <div class="d-flex align-items-center justify-content-center">
                                <div class="spinner-border spinner-border-sm text-primary me-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <!-- Waiting Message -->
                                <div>
                                    <div class="fw-bold text-primary">Đang xử lý kết quả...</div>
                                    <small class="text-muted">Hãy xem video hướng dẫn trong lúc chờ đợi</small>
                                </div>
                            </div>
                        </div>
                        <div class="video-wrapper">
                            <div id="youtubePlayerPlaceholder" style="background: #000; display: flex; align-items: center; justify-content: center; height: 315px; border-radius: 12px;">
                                <div class="text-white text-center">
                                    <i class="fas fa-play-circle" style="font-size: 3rem; margin-bottom: 10px;"></i>
                                    <div>Đang tải video...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- View Results Button (Hidden by default) -->
                    <div id="viewResultsContainer" style="display: none; margin-top: 30px; text-align: center;">
                        <button class="btn btn-pac-primary" onclick="window.location.href='my-tests'">
                            Xem kết quả ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer Section Container -->
    <div id="footer-section">
        <!-- Footer component will be loaded here -->
    </div>
    
    <!-- Scripts -->
    <script>
        // Configure components for this page - must be defined before component-loader.js
        window.pageComponentsConfig = [
            { name: 'header', target: '#header-section' },
            { name: 'footer', target: '#footer-section' }
        ];
    </script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/vendor/aos/aos.js"></script>
    <script src="assets/js/toastbar.js?v=20112025"></script>
    <script src="assets/js/component-loader.js?v=20112025"></script>
    
    <script>
        // Test Manager Class
        class TestManager {
            constructor() {
                this.questions = [];
                this.currentQuestionIndex = 0;
                this.answers = {};
                this.examId = null;
                this.fixedChoices = [];
                this.timeLimit = 30 * 60; // 30 minutes in seconds
                this.timeRemaining = this.timeLimit;
                this.timer = null;
                this.startTime = new Date();
                
                this.initializeTest();
            }
            
            async initializeTest() {
                try {
                    showToast('Đang tải trắc nghiệm...', 'Vui lòng chờ trong giây lát', 'info');
                    
                    // Create exam session (may include questions in response)
                    await this.createExamSession();
                    
                    // Only call get-questions if questions weren't included in create-exam response
                    if (!this.questions || this.questions.length === 0) {
                        await this.loadQuestionsFromAPI();
                    }
                    
                    // Setup UI
                    this.renderMinimap();
                    this.renderQuestion();
                    this.startTimer();
                    this.updateStats();
                    
                    showToast('Thành công!', 'Trắc nghiệm đã được tải thành công.', 'success');
                    console.log('✅ Test initialized successfully');
                } catch (error) {
                    console.error('❌ Error initializing test:', error);
                    showToast('Lỗi', 'Không thể tải trắc nghiệm. Vui lòng thử lại.', 'error');
                }
            }
            
            async createExamSession() {
                try {
                    console.log('🔄 Creating exam session...');
                    
                    // Check if we have an access_code in URL (from purchased package)
                    const urlParams = new URLSearchParams(window.location.search);
                    const accessCode = urlParams.get('access_code');
                    const packageId = urlParams.get('package_id');
                    
                    let requestBody, apiEndpoint;
                    
                    if (accessCode) {
                        // Find package_id from access_code via purchased_packages
                        console.log('🔍 Finding package for access_code:', accessCode);
                        
                        const packageResponse = await fetch(`api/packages/get-package-by-access-code.php?access_code=${accessCode}`, {
                            method: 'GET',
                            credentials: 'include'
                        });
                        
                        if (packageResponse.ok) {
                            const packageData = await packageResponse.json();
                            if (packageData.status === 'success' && packageData.data.package_id) {
                                console.log('✅ Found package:', packageData.data.package_id);
                                apiEndpoint = 'api/quiz/create-exam-from-package.php';
                                requestBody = {
                                    package_id: packageData.data.package_id
                                };
                            } else {
                                throw new Error('Không tìm thấy gói từ access_code');
                            }
                        } else {
                            console.warn('⚠️ Could not find package from access_code, falling back to FREE');
                            apiEndpoint = 'api/quiz/create-exam.php';
                            requestBody = { exam_type: 'FREE' };
                        }
                    } else if (packageId) {
                        // Direct package_id from URL
                        console.log('📦 Using package_id from URL:', packageId);
                        apiEndpoint = 'api/quiz/create-exam-from-package.php';
                        requestBody = {
                            package_id: parseInt(packageId)
                        };
                    } else {
                        // Default to FREE quiz
                        console.log('🆓 Using default FREE quiz');
                        apiEndpoint = 'api/quiz/create-exam.php';
                        requestBody = { exam_type: 'FREE' };
                    }
                    
                    let response = await fetch(apiEndpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(requestBody)
                    });
                    
                    console.log('Response status:', response.status);
                    
                    let responseText = await response.text();
                    console.log('Response text:', responseText);
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error(`Parse error: ${parseError.message}. Raw response: ${responseText}`);
                    }
                    
                    // If error 460 (incomplete exam exists), try with force_new
                    if (!response.ok && data.error_code === 460) {
                        console.log('🔄 Incomplete exam found, trying with force_new...');
                        
                        // Add force_new to the existing request body
                        requestBody.force_new = true;
                        
                        response = await fetch(apiEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify(requestBody)
                        });
                        
                        console.log('Force new response status:', response.status);
                        
                        responseText = await response.text();
                        console.log('Force new response text:', responseText);
                        
                        try {
                            data = JSON.parse(responseText);
                        } catch (parseError) {
                            throw new Error(`Parse error: ${parseError.message}. Raw response: ${responseText}`);
                        }
                    }
                    
                    if (response.ok && data.status === 'success') {
                        // Handle different response structures
                        if (data.data.exam_info && data.data.exam_info.exam_id) {
                            // Package-based exam response structure
                            this.examId = data.data.exam_info.exam_id;
                            
                            // Questions are nested under exam_info
                            if (data.data.exam_info.questions && data.data.exam_info.questions.length > 0) {
                                this.questions = data.data.exam_info.questions;
                                this.fixedChoices = data.data.fixed_choices || [];
                                
                                // Update UI with actual question count
                                document.getElementById('totalQuestions').textContent = this.questions.length;
                                document.getElementById('remainingCount').textContent = this.questions.length;
                                
                                console.log('✅ Questions loaded from package exam response:', this.questions.length);
                                return; // Skip separate get-questions call
                            }
                        } else if (data.data.exam_id) {
                            // Regular exam response structure
                            this.examId = data.data.exam_id;
                            
                            // If response includes questions, use them directly
                            if (data.data.questions && data.data.questions.length > 0) {
                                this.questions = data.data.questions;
                                this.fixedChoices = data.data.fixed_choices || [];
                                
                                // Update UI with actual question count
                                document.getElementById('totalQuestions').textContent = this.questions.length;
                                document.getElementById('remainingCount').textContent = this.questions.length;
                                
                                console.log('✅ Questions loaded from regular exam response:', this.questions.length);
                                return; // Skip separate get-questions call
                            }
                        }
                        
                        console.log('✅ Exam session created:', this.examId);
                    } else {
                        throw new Error(data.message || `HTTP ${response.status}: ${responseText}`);
                    }
                } catch (error) {
                    console.error('❌ Error creating exam session:', error);
                    throw error;
                }
            }
            
            async loadQuestionsFromAPI() {
                try {
                    if (!this.examId) {
                        throw new Error('No exam session available');
                    }
                    
                    console.log('🔄 Loading questions for exam:', this.examId);
                    
                    const response = await fetch(`api/quiz/get-questions.php?exam_id=${this.examId}`, {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    console.log('Response status:', response.status);
                    
                    const responseText = await response.text();
                    console.log('Response text:', responseText);
                    
                    let data;
                    try {
                        data = JSON.parse(responseText);
                    } catch (parseError) {
                        throw new Error(`Parse error: ${parseError.message}. Raw response: ${responseText}`);
                    }
                    
                    if (response.ok && data.status === 'success') {
                        this.questions = data.data.questions;
                        this.fixedChoices = data.data.fixed_choices || [];
                        
                        // Update UI with actual question count
                        document.getElementById('totalQuestions').textContent = this.questions.length;
                        document.getElementById('remainingCount').textContent = this.questions.length;
                        
                        console.log('✅ Questions loaded:', this.questions.length);
                    } else {
                        throw new Error(data.message || `HTTP ${response.status}: ${responseText}`);
                    }
                } catch (error) {
                    console.error('❌ Error loading questions:', error);
                    throw error;
                }
            }
            
            renderMinimap() {
                const minimap = document.getElementById('questionMinimap');
                minimap.innerHTML = '';
                
                for (let i = 0; i < this.questions.length; i++) {
                    const questionBtn = document.createElement('div');
                    questionBtn.className = 'minimap-question';
                    questionBtn.textContent = i + 1;
                    questionBtn.onclick = () => this.goToQuestion(i);
                    
                    // Add appropriate classes
                    if (i === this.currentQuestionIndex) {
                        questionBtn.classList.add('current');
                    }
                    
                    // Check if question is answered using question ID
                    const questionId = this.questions[i].id;
                    if (this.answers[questionId] !== undefined) {
                        questionBtn.classList.add('answered');
                    }
                    
                    minimap.appendChild(questionBtn);
                }
            }
            
            
            renderQuestion() {
                const container = document.getElementById('questionContainer');
                const question = this.questions[this.currentQuestionIndex];
                
                if (!question) return;
                
                // Use choices from API response (3 choices per question)
                const choices = question.choices || [];
                
                // Get current answer using question ID
                const currentAnswer = this.answers[question.id];
                
                const optionsHTML = choices.map((choice, choiceIndex) => `
                    <div class="answer-option ${currentAnswer === choice.value ? 'selected' : ''}" 
                         onclick="testManager.selectAnswer(${choice.value})">
                        <label class="answer-label">
                            <input type="radio" name="question${question.id}" value="${choice.value}" class="answer-radio" 
                                   ${currentAnswer === choice.value ? 'checked' : ''}>
                            <div class="answer-marker"></div>
                            <div class="answer-text">${choice.text}</div>
                        </label>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="question-header">
                        <div class="question-number">Câu hỏi ${this.currentQuestionIndex + 1}</div>
                        <div class="question-type">${this.questions.length} câu hỏi</div>
                    </div>
                    
                    <div class="question-content">
                        <h3 class="question-text">${question.question_text}</h3>
                        <p class="question-description">
                            Chọn mức độ đồng ý của bạn với câu phát biểu trên:
                        </p>
                    </div>
                    
                    <div class="answers-section">
                        ${optionsHTML}
                    </div>
                    
                    <div class="question-actions">
                        <button class="btn-nav btn-prev" onclick="testManager.previousQuestion()" 
                                ${this.currentQuestionIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-chevron-left"></i>
                            Câu trước
                        </button>
                        
                        <div>
                            ${this.currentQuestionIndex === this.questions.length - 1 ? `
                                <button class="btn-nav btn-next" onclick="testManager.finishTest()">
                                    <i class="fas fa-check"></i>
                                    Hoàn thành
                                </button>
                            ` : `
                                <button class="btn-nav btn-next" onclick="testManager.nextQuestion()">
                                    Câu tiếp
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            `}
                        </div>
                    </div>
                `;
            }
            
            selectAnswer(answerIndex) {
                // Store answer using question ID (not index)
                const currentQuestion = this.questions[this.currentQuestionIndex];
                this.answers[currentQuestion.id] = answerIndex;
                
                console.log(`Selected answer for question ${currentQuestion.id}: ${answerIndex}`);
                
                this.renderQuestion();
                this.renderMinimap();
                this.updateStats();
            }
            
            goToQuestion(index) {
                if (index >= 0 && index < this.questions.length) {
                    this.currentQuestionIndex = index;
                    this.renderQuestion();
                    this.renderMinimap();
                }
            }
            
            nextQuestion() {
                if (this.currentQuestionIndex < this.questions.length - 1) {
                    this.currentQuestionIndex++;
                    this.renderQuestion();
                    this.renderMinimap();
                }
            }
            
            previousQuestion() {
                if (this.currentQuestionIndex > 0) {
                    this.currentQuestionIndex--;
                    this.renderQuestion();
                    this.renderMinimap();
                }
            }
            
            updateStats() {
                const answeredCount = Object.keys(this.answers).length;
                const remainingCount = this.questions.length - answeredCount;
                const progressPercent = (answeredCount / this.questions.length) * 100;
                
                document.getElementById('answeredCount').textContent = answeredCount;
                document.getElementById('remainingCount').textContent = remainingCount;
                document.getElementById('progressText').textContent = `${answeredCount}/${this.questions.length}`;
                document.getElementById('progressBar').style.width = `${progressPercent}%`;
                
                // Calculate time used
                const timeUsed = Math.floor((new Date() - this.startTime) / 1000);
                const minutes = Math.floor(timeUsed / 60);
                const seconds = timeUsed % 60;
                document.getElementById('timeUsed').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            startTimer() {
                this.timer = setInterval(() => {
                    this.timeRemaining--;
                    this.updateTimerDisplay();
                    
                    if (this.timeRemaining <= 0) {
                        this.timeUp();
                    }
                }, 1000);
            }
            
            updateTimerDisplay() {
                const minutes = Math.floor(this.timeRemaining / 60);
                const seconds = this.timeRemaining % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                document.getElementById('timeRemaining').textContent = timeString;
                
                const timerCard = document.querySelector('.timer-card');
                
                // Warning states
                if (this.timeRemaining <= 300) { // 5 minutes
                    timerCard?.classList.add('timer-warning');
                }
                if (this.timeRemaining <= 60) { // 1 minute
                    timerCard?.classList.remove('timer-warning');
                    timerCard?.classList.add('timer-danger');
                }
            }
            
            timeUp() {
                clearInterval(this.timer);
                this.isSubmitting = true; // Disable beforeunload warning
                showToast('Hết giờ!', 'Thời gian làm bài đã kết thúc. Trắc nghiệm sẽ được nộp tự động.', 'warning', 5000);
                setTimeout(() => {
                    this.submitTest();
                }, 2000);
            }
            
            autoFillAllQuestions() {
                console.log('🎲 Auto-filling all questions with random answers...');
                
                let filledCount = 0;
                
                // Loop through all questions and assign random answers
                this.questions.forEach((question, index) => {
                    // Generate random answer (0, 1, or 2)
                    const randomAnswer = Math.floor(Math.random() * 3);
                    
                    // Store the answer using question ID (not index)
                    this.answers[question.id] = randomAnswer;
                    filledCount++;
                    
                    console.log(`Question ${index + 1} (${question.id}): Auto-selected option ${randomAnswer}`);
                });
                
                // Update progress and display
                this.updateStats();
                this.renderQuestion();
                this.renderMinimap();
                
                // Show success message
                showToast(
                    'Auto Fill Complete!', 
                    `Đã tự động chọn đáp án cho ${filledCount} câu hỏi. Bạn có thể xem lại và chỉnh sửa nếu cần.`, 
                    'success', 
                    3000
                );
                
                console.log('🎲 Auto-fill completed. Current answers:', this.answers);
                console.log('📊 To submit: testManager.finishTest()');
                
                return this.answers;
            }
            
            finishTest() {
                const answeredCount = Object.keys(this.answers).length;
                const unansweredCount = this.questions.length - answeredCount;
                
                if (unansweredCount > 0) {
                    const confirmMessage = `Bạn còn ${unansweredCount} câu chưa trả lời. Bạn có chắc chắn muốn hoàn thành trắc nghiệm?`;
                    if (!confirm(confirmMessage)) {
                        return;
                    }
                }
                
                // Disable beforeunload warning since user is finishing the test
                this.isSubmitting = true;
                
                // Show completion screen
                document.getElementById('questionContainer').style.display = 'none';
                document.getElementById('testCompleteScreen').style.display = 'block';
                
                clearInterval(this.timer);
            }
            
            async submitTest() {
                try {
                    // Disable the beforeunload warning since user is intentionally submitting
                    this.isSubmitting = true;
                    
                    // Hide completion message and show video player
                    document.getElementById('completionMessage').style.display = 'none';
                    document.getElementById('videoPlayerContainer').style.display = 'block';
                    
                    // Create and start YouTube video when submitting
                    this.createYouTubePlayer();
                    
                    showToast('Đang nộp bài...', 'Vui lòng chờ trong giây lát', 'info');
                    
                    // Prepare answers for submission
                    const submissionData = {
                        exam_id: this.examId,
                        answers: this.answers
                    };
                    
                    console.log('Submitting answers:', submissionData);
                    
                    // Submit to API
                    const response = await fetch('api/quiz/submit-quiz.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        credentials: 'include',
                        body: JSON.stringify(submissionData)
                    });
                    
                    console.log('Submit response status:', response.status);
                    
                    const responseText = await response.text();
                    console.log('Submit raw response:', responseText);
                    
                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        console.error('Failed to parse response as JSON:', parseError);
                        throw new Error(`Server response invalid. Status: ${response.status}`);
                    }
                    
                    console.log('Submit API response:', result);
                    
                    if (response.ok && result.status === 'success') {
                        showToast('Thành công!', 'Trắc nghiệm đã được nộp thành công!', 'success', 3000);
                        
                        // Hide the waiting message
                        const videoStatusMessage = document.querySelector('.video-status-message');
                        if (videoStatusMessage) {
                            videoStatusMessage.style.display = 'none';
                        }
                        
                        // Show "View Results Now" button
                        document.getElementById('viewResultsContainer').style.display = 'block';
                    } else {
                        console.error('API Error Details:', result);
                        
                        // Handle specific error cases
                        let errorMessage = result.message || result.details || 'Có lỗi xảy ra khi nộp bài';
                        
                        if (result.error_code === 404) {
                            errorMessage = 'Trắc nghiệm không tồn tại hoặc đã được nộp trước đó';
                        } else if (result.error_code === 401) {
                            errorMessage = 'Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại';
                            setTimeout(() => {
                                window.location.href = 'dangnhap';
                            }, 3000);
                        }
                        
                        // Show submit button again on error
                        document.getElementById('submitTestBtn').style.display = 'inline-flex';
                        document.getElementById('videoPlayerContainer').style.display = 'none';
                        
                        throw new Error(errorMessage);
                    }
                    
                } catch (error) {
                    console.error('❌ Error submitting test:', error);
                    showToast('Lỗi nộp bài', `${error.message}`, 'error', 5000);
                    
                    // Show submit button again on error
                    document.getElementById('submitTestBtn').style.display = 'inline-flex';
                    document.getElementById('videoPlayerContainer').style.display = 'none';
                }
            }
            
            createYouTubePlayer() {
                // Replace placeholder with actual YouTube iframe
                const placeholder = document.getElementById('youtubePlayerPlaceholder');
                if (placeholder) {
                    placeholder.innerHTML = `
                        <iframe id="youtubePlayer" 
                                width="560" 
                                height="315" 
                                src="https://www.youtube.com/embed/hsI0Uoz8sXA?autoplay=1&mute=0&rel=0&showinfo=0&enablejsapi=1" 
                                title="PAC Group - Hướng dẫn đọc kết quả" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                                allowfullscreen>
                        </iframe>
                    `;
                    console.log('✅ YouTube player created and started');
                }
            }
        }
        
        // Initialize test when DOM is loaded
        let testManager;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize AOS
            AOS.init({
                duration: 1000,
                easing: 'ease-in-out',
                once: true,
                mirror: false
            });
            
            // Initialize test after components are loaded
            setTimeout(() => {
                testManager = new TestManager();
            }, 1000);
            
            // Prevent accidental page refresh during test
            window.addEventListener('beforeunload', function (e) {
                if (testManager && testManager.timer && !testManager.isSubmitting) {
                    e.preventDefault();
                    e.returnValue = 'Bạn có chắc chắn muốn rời khỏi trang? Tiến độ làm trắc nghiệm sẽ bị mất.';
                    return e.returnValue;
                }
            });
        });
        
        // Global function for submit button
        function submitTest() {
            if (testManager) {
                testManager.submitTest();
            }
        }
    </script>
</body>
</html>