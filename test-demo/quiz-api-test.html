<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Holland Code Quiz APIs</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .test-section h2 {
            color: #34495e;
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        button.danger {
            background: #e74c3c;
        }
        
        button.danger:hover {
            background: #c0392b;
        }
        
        .response {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .response.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .response.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .response.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .current-session {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß† Holland Code Quiz API Testing</h1>
        
        <!-- Session Info -->
        <div class="current-session">
            <h3>üìã Current Session</h3>
            <p><strong>User ID:</strong> <span id="currentUserId">2</span> (Nguy·ªÖn VƒÉn A - customer@example.com)</p>
            <p><strong>Session:</strong> <span style="color: green;">‚úì Using account from sample-data.sql</span></p>
            <div class="quick-actions">
                <button onclick="setupSession()">üîë Setup Session</button>
                <button onclick="clearAllResponses()">üóëÔ∏è Clear All</button>
                <button onclick="showApiDocs()">üìñ API Docs</button>
            </div>
        </div>

        <!-- Test 1: Create Exam -->
        <div class="test-section">
            <h2>üöÄ Test 1: Create Exam</h2>
            <div class="form-group">
                <label for="examType">Exam Type:</label>
                <select id="examType">
                    <option value="FREE">FREE (30 c√¢u, 30 ph√∫t)</option>
                    <option value="PAID">PAID (120 c√¢u, kh√¥ng gi·ªõi h·∫°n)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="userId">User ID (optional):</label>
                <input type="number" id="userId" placeholder="2" value="2">
            </div>
            <button onclick="testCreateExam()">üìù Create Exam</button>
            <div id="createExamResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Test 2: Get Questions -->
        <div class="test-section">
            <h2>üìã Test 2: Get Questions</h2>
            <div class="form-group">
                <label for="examIdForQuestions">Exam ID:</label>
                <input type="number" id="examIdForQuestions" placeholder="S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn t·ª´ Create Exam">
            </div>
            <button onclick="testGetQuestions()">üìÑ Get Questions</button>
            <button onclick="autoFillExamId()">üîÑ Auto Fill t·ª´ Create Exam</button>
            <div id="getQuestionsResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Test 3: Sample Question Display -->
        <div class="test-section">
            <h2>üéØ Test 3: Question Preview</h2>
            <p>Preview c√¢u h·ªèi v·ªõi 3 choices c·ªë ƒë·ªãnh (Holland Code style):</p>
            <div id="questionPreview" style="background: white; padding: 20px; border: 1px solid #ddd; border-radius: 5px;">
                <div style="margin-bottom: 15px;">
                    <strong>C√¢u 1:</strong> T√¥i th√≠ch l√†m vi·ªác v·ªõi m√°y m√≥c v√† thi·∫øt b·ªã k·ªπ thu·∫≠t
                </div>
                <div>
                    <label style="display: block; margin: 8px 0; cursor: pointer;">
                        <input type="radio" name="demo" value="0" style="width: auto; margin-right: 10px;">
                        <span style="color: #e74c3c;">Kh√¥ng ƒë·ªìng √Ω (0 ƒëi·ªÉm)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; cursor: pointer;">
                        <input type="radio" name="demo" value="1" style="width: auto; margin-right: 10px;">
                        <span style="color: #f39c12;">B√¨nh th∆∞·ªùng (1 ƒëi·ªÉm)</span>
                    </label>
                    <label style="display: block; margin: 8px 0; cursor: pointer;">
                        <input type="radio" name="demo" value="2" style="width: auto; margin-right: 10px;">
                        <span style="color: #27ae60;">ƒê·ªìng √Ω (2 ƒëi·ªÉm)</span>
                    </label>
                </div>
            </div>
            <button onclick="showQuestionStructure()">üîç Show JSON Structure</button>
            <div id="questionStructureResponse" class="response" style="display: none;"></div>
        </div>

        <!-- Test 4: API Documentation -->
        <div class="test-section">
            <h2>üìö API Documentation</h2>
            <div id="apiDocs" style="display: none;">
                <h3>POST api/quiz/create-exam.php</h3>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
Request:
{
  "exam_type": "FREE|PAID",
  "user_id": 123 (optional)
}

Response Success:
{
  "status": "success",
  "data": {
    "exam_id": 456,
    "exam_code": "EX20251101_ABC123", 
    "exam_type": "FREE",
    "total_questions": 30,
    "time_limit": 30,
    "questions": [...],
    "instructions": {...},
    "fixed_choices": [
      {"value": 0, "text": "Kh√¥ng ƒë·ªìng √Ω", "points": 0},
      {"value": 1, "text": "B√¨nh th∆∞·ªùng", "points": 1},
      {"value": 2, "text": "ƒê·ªìng √Ω", "points": 2}
    ]
  }
}
                </pre>
                
                <h3>GET api/quiz/get-questions.php</h3>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 4px;">
Request: ?exam_id=456

Response Success:
{
  "status": "success",
  "data": {
    "exam_info": {
      "exam_id": 456,
      "total_questions": 30,
      "answered_questions": 5,
      "progress": 16.7,
      "time_remaining": 1800
    },
    "questions": [...],
    "fixed_choices": [...]
  }
}
                </pre>
            </div>
            <button onclick="toggleApiDocs()">üìñ Toggle Documentation</button>
        </div>
    </div>

    <script>
        let lastExamId = null;
        
        // Setup session first
        async function setupSession() {
            try {
                const response = await fetch('test-demo/setup-session.php');
                const data = await response.json();
                
                if (data.status === 'success') {
                    showResponse('createExamResponse', 
                        `‚úÖ Session Setup Success\n\n${JSON.stringify(data, null, 2)}`, 
                        'success'
                    );
                } else {
                    showResponse('createExamResponse', 
                        `‚ùå Session Setup Failed\n\n${JSON.stringify(data, null, 2)}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResponse('createExamResponse', 
                    `üí• Session Setup Error\n\n${error.message}`, 
                    'error'
                );
            }
        }
        
        // Test Create Exam
        async function testCreateExam() {
            const examType = document.getElementById('examType').value;
            const userId = document.getElementById('userId').value;
            
            const requestData = {
                exam_type: examType
            };
            
            if (userId) {
                requestData.user_id = parseInt(userId);
            }
            
            try {
                showResponse('createExamResponse', 'Sending request...', 'warning');
                
                const response = await fetch('api/quiz/create-exam.php', {
                    method: 'POST',
                    credentials: 'include', // Include cookies for session
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response URL:', response.url);
                
                // Get response text for debugging
                const responseText = await response.text();
                console.log('Response text:', responseText);
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // If not JSON, show raw response
                    showResponse('createExamResponse', 
                        `‚ùå PARSE ERROR (${response.status})\n\nRaw Response:\n${responseText}\n\nParse Error:\n${parseError.message}`, 
                        'error'
                    );
                    return;
                }
                
                if (response.ok && data.status === 'success') {
                    lastExamId = data.data.exam_id;
                    showResponse('createExamResponse', 
                        `‚úÖ SUCCESS (${response.status})\n\n` + JSON.stringify(data, null, 2), 
                        'success'
                    );
                } else {
                    showResponse('createExamResponse', 
                        `‚ùå ERROR (${response.status})\n\n` + JSON.stringify(data, null, 2), 
                        'error'
                    );
                }
            } catch (error) {
                console.error('Network error:', error);
                showResponse('createExamResponse', 
                    `üí• NETWORK ERROR\n\n${error.message}`, 
                    'error'
                );
            }
        }
        
        // Test Get Questions
        async function testGetQuestions() {
            const examId = document.getElementById('examIdForQuestions').value;
            
            if (!examId) {
                showResponse('getQuestionsResponse', '‚ö†Ô∏è Please enter Exam ID', 'warning');
                return;
            }
            
            try {
                showResponse('getQuestionsResponse', 'Fetching questions...', 'warning');
                
                const response = await fetch(`api/quiz/get-questions.php?exam_id=${examId}`, {
                    method: 'GET',
                    credentials: 'include', // Include cookies for session
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                console.log('Get Questions Response status:', response.status);
                console.log('Get Questions Response URL:', response.url);
                
                // Get response text for debugging
                const responseText = await response.text();
                console.log('Get Questions Response text:', responseText);
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    // If not JSON, show raw response
                    showResponse('getQuestionsResponse', 
                        `‚ùå PARSE ERROR (${response.status})\n\nRaw Response:\n${responseText}\n\nParse Error:\n${parseError.message}`, 
                        'error'
                    );
                    return;
                }
                
                if (response.ok && data.status === 'success') {
                    // Simplify response for display
                    const simplifiedData = {
                        ...data,
                        data: {
                            ...data.data,
                            questions: data.data.questions.slice(0, 3).map(q => ({
                                id: q.id,
                                question_number: q.question_number,
                                question_text: q.question_text,
                                choices: q.choices,
                                is_answered: q.is_answered
                            }))
                        }
                    };
                    
                    showResponse('getQuestionsResponse', 
                        `‚úÖ SUCCESS (${response.status})\n\nShowing first 3 questions:\n\n` + 
                        JSON.stringify(simplifiedData, null, 2), 
                        'success'
                    );
                } else {
                    showResponse('getQuestionsResponse', 
                        `‚ùå ERROR (${response.status})\n\n` + JSON.stringify(data, null, 2), 
                        'error'
                    );
                }
            } catch (error) {
                console.error('Get Questions Network error:', error);
                showResponse('getQuestionsResponse', 
                    `üí• NETWORK ERROR\n\n${error.message}`, 
                    'error'
                );
            }
        }
        
        // Auto fill exam ID from last create
        function autoFillExamId() {
            if (lastExamId) {
                document.getElementById('examIdForQuestions').value = lastExamId;
                showResponse('getQuestionsResponse', `‚úÖ Auto-filled with Exam ID: ${lastExamId}`, 'success');
            } else {
                showResponse('getQuestionsResponse', '‚ö†Ô∏è No exam created yet. Please create an exam first.', 'warning');
            }
        }
        
        // Show question structure
        function showQuestionStructure() {
            const questionExample = {
                id: "Q001",
                question_number: 1,
                question_text: "T√¥i th√≠ch l√†m vi·ªác v·ªõi m√°y m√≥c v√† thi·∫øt b·ªã k·ªπ thu·∫≠t",
                category: "technical",
                question_type: "interest",
                choices: [
                    {value: 0, text: "Kh√¥ng ƒë·ªìng √Ω", points: 0},
                    {value: 1, text: "B√¨nh th∆∞·ªùng", points: 1},
                    {value: 2, text: "ƒê·ªìng √Ω", points: 2}
                ],
                current_answer: null,
                is_answered: false,
                holland_code: null // Hidden in production
            };
            
            showResponse('questionStructureResponse', 
                'üìã Question JSON Structure:\n\n' + JSON.stringify(questionExample, null, 2), 
                'success'
            );
        }
        
        // Utility functions
        function showResponse(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `response ${type}`;
            element.style.display = 'block';
        }
        
        function clearAllResponses() {
            const responses = document.querySelectorAll('.response');
            responses.forEach(response => {
                response.style.display = 'none';
            });
        }
        
        function toggleApiDocs() {
            const docs = document.getElementById('apiDocs');
            docs.style.display = docs.style.display === 'none' ? 'block' : 'none';
        }
        
        function showApiDocs() {
            document.getElementById('apiDocs').style.display = 'block';
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß† Holland Code Quiz API Tester Ready!');
            console.log('üìù Using customer account from sample-data.sql');
            console.log('üìù APIs Available:');
            console.log('   - POST api/quiz/create-exam.php');
            console.log('   - GET  api/quiz/get-questions.php');
            console.log('üí° Click "Setup Session" first to authenticate!');
        });
    </script>
</body>
</html>