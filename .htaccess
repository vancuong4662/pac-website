RewriteEngine On

# Enable CORS for XHR API requests and Component Loading
<IfModule mod_headers.c>
    # Allow XHR requests from same origin
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Allow-Credentials "true"
</IfModule>

# Component Loading Support
<Files ~ "^components/.*\.html$">
    # Set correct MIME type for HTML components
    Header set Content-Type "text/html; charset=UTF-8"
    
    # Allow CORS for components
    Header always set Access-Control-Allow-Origin "*"
    
    # Cache components for better performance but shorter for development
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresDefault "access plus 1 hour"
    </IfModule>
</Files>

# Handle preflight OPTIONS requests for API
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteCond %{REQUEST_URI} ^/pac-new/api/
RewriteRule ^(.*)$ - [R=200,L]

# Security Headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Skip rewriting for static files and uploads
RewriteCond %{REQUEST_URI} \.(css|js|png|jpg|jpeg|gif|webp|ico|svg|woff|woff2|ttf|pdf|zip|rar|mp4|mp3)$ [NC]
RewriteRule ^ - [L]

# Skip rewriting for components directory - allow direct access to HTML components
RewriteCond %{REQUEST_URI} ^/pac-new/components/ [NC]
RewriteRule ^ - [L]

# Skip rewriting for API endpoints - let PHP handle these
RewriteCond %{REQUEST_URI} ^/pac-new/api/ [NC]
RewriteRule ^ - [L]

# Skip rewriting for existing files/directories
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Custom Error Pages
ErrorDocument 404 /pac-new/templates/404.html
ErrorDocument 403 /pac-new/templates/403.html
ErrorDocument 500 /pac-new/templates/500.html

# Pretty URLs for main pages
RewriteRule ^$ index.html [L]
RewriteRule ^home/?$ index.html [L]
RewriteRule ^about/?$ templates/about.html [L]
RewriteRule ^su-menh-tam-nhin/?$ templates/about.html [L]
RewriteRule ^mo-hinh-danh-gia/?$ templates/models.html [L]
RewriteRule ^doi-ngu-co-van/?$ templates/expert.html [L]
RewriteRule ^services/?$ templates/services.html [L]
RewriteRule ^service/([^/]+)/?$ templates/service-detail.html?service=$1 [L]
RewriteRule ^contact/?$ templates/contact.html [L]
RewriteRule ^huongnghiep/?$ templates/solution.html [L]
RewriteRule ^goihuongnghiep-([^/]+)/?$ templates/package-detail.html?id=$1 [L]
RewriteRule ^khoahoc/?$ templates/courses.html [L]
RewriteRule ^chitietkhoahoc-([^/]+)/?$ templates/course-detail.html?id=$1 [L]
RewriteRule ^dangnhap/?$ templates/login.html [L]
RewriteRule ^dangky/?$ templates/register.html [L]
RewriteRule ^profile/?$ templates/profile.html [L]
RewriteRule ^payment-history/?$ templates/payment-history.html [L]
RewriteRule ^test-results/?$ templates/test-results.html [L]

# E-commerce and Shopping Cart pages
RewriteRule ^product/([^/]+)/?$ templates/product-detail.html?id=$1 [L]
RewriteRule ^cart/?$ templates/cart.html [L]
RewriteRule ^checkout/?$ templates/checkout.html [L]
RewriteRule ^order-confirmation/?$ templates/order-confirmation.html [L]

# Payment System Routes (flat structure to avoid path issues)
RewriteRule ^payment-vnpay/?$ templates/checkout.html?method=vnpay [L]
RewriteRule ^payment-result/?$ templates/payment-result.html [L]
RewriteRule ^payment-success/?$ templates/payment-result.html?status=success [L]
RewriteRule ^payment-failed/?$ templates/payment-result.html?status=failed [L]
RewriteRule ^payment-cancel/?$ templates/payment-result.html?status=cancelled [L]

# VNPay Integration Routes (for API callbacks)
RewriteRule ^vnpay-return/?$ api/orders/vnpay-return.php [L]
RewriteRule ^vnpay-ipn/?$ api/orders/vnpay-ipn.php [L]
RewriteRule ^vnpay-test/?$ test/vnpay-test.html [L]

# Purchase Management pages
RewriteRule ^my-purchases/?$ templates/my-purchases.html [L]
RewriteRule ^my-courses/?$ templates/my-courses.html [L]
RewriteRule ^my-tests/?$ templates/my-tests.html [L]
RewriteRule ^my-consultations/?$ templates/my-consultations.html [L]

# Course related pages
RewriteRule ^course-detail/?$ templates/course-detail.html [L]
RewriteRule ^course-player/?$ templates/course-player.html [L]

# Test related pages  
RewriteRule ^test/?$ templates/test.html [L]
RewriteRule ^test-details/?$ templates/test-details.html [L]

# Consultation related pages
RewriteRule ^consultation-details/?$ templates/consultation-details.html [L]

# Test route page (for development)
RewriteRule ^test-routes/?$ test-routes.html [L]

# Admin pages (with authentication check) - All at root level
RewriteRule ^admin/?$ templates/admin/login.html [L]
RewriteRule ^admin-dashboard/?$ templates/admin/dashboard.html [L]
RewriteRule ^admin-consultations/?$ templates/admin/consultations.html [L]
RewriteRule ^admin-courses/?$ templates/admin/courses.html [L]
RewriteRule ^admin-tests/?$ templates/admin/tests.html [L]
RewriteRule ^admin-orders/?$ templates/admin/orders.html [L]
RewriteRule ^admin-users/?$ templates/admin/users.html [L]
RewriteRule ^admin-settings/?$ templates/admin/settings.html [L]

# Cache Control for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    # Images
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType image/svg+xml "access plus 1 month"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType font/truetype "access plus 1 year"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
</IfModule>

# Prevent access to sensitive files
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak)$">
    Require all denied
</FilesMatch>

# Prevent access to config and includes directories
RewriteRule ^api/config/ - [F,L]
RewriteRule ^api/includes/ - [F,L]

# Force HTTPS (uncomment when ready for production)
# RewriteCond %{HTTPS} off
# RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]