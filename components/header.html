<!-- Top Info Bar -->
<div id="topbar" class="topbar d-flex align-items-center">
  <div class="container d-flex justify-content-between align-items-center">
    <!-- Mobile menu toggle (chỉ hiện trên mobile/tablet) -->
    <button class="mobile-menu-toggle d-xl-none" type="button">
      <i class="bi bi-list"></i>
    </button>
    
    <!-- Contact info (chỉ hiện trên desktop) -->
    <div class="contact-info d-xl-flex d-none align-items-center">
      <i class="bi bi-envelope-fill me-1"></i>
      <span class="me-4">info@pacgroup.org</span>
      <i class="bi bi-telephone-fill me-1"></i>
      <span>096 501 3663</span>
    </div>
    
    <!-- Right side items (desktop: social + auth + cart, mobile: chỉ auth + cart) -->
    <div class="d-flex align-items-center">
      <!-- Social links (chỉ hiện trên desktop) -->
      <div class="social-links d-xl-flex d-none me-3">
        <a href="#" class="social-icon"><i class="bi bi-facebook"></i></a>
        <a href="#" class="social-icon"><i class="bi bi-youtube"></i></a>
        <a href="#" class="social-icon"><i class="bi bi-instagram"></i></a>
        <a href="#" class="social-icon"><i class="bi bi-globe"></i></a>
      </div>
      
      <!-- Auth buttons -->
      <div class="auth-buttons d-flex align-items-center">
        <!-- Not authenticated state (default) -->
        <div id="auth-not-logged-in" class="auth-state">
          <a href="dangnhap" class="auth-btn me-2">
            <i class="bi bi-person-fill me-1"></i>ĐĂNG NHẬP
          </a>
          <span class="separator">|</span>
          <a href="dangky" class="auth-btn ms-2 me-3">ĐĂNG KÝ</a>
        </div>
        
        <!-- Authenticated state (hidden by default) -->
        <div id="auth-logged-in" class="auth-state" style="display: none;">
          <div class="dropdown user-dropdown">
            <a href="#" class="auth-btn dropdown-toggle d-flex align-items-center me-3" 
               id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle me-1"></i>
              <span id="user-display-name">Người dùng</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li>
                <a class="dropdown-item" href="profile">
                  <i class="bi bi-person me-2"></i>Hồ sơ cá nhân
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="my-purchases">
                  <i class="bi bi-bag me-2"></i>Quản lý mua hàng
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="my-courses">
                  <i class="bi bi-book me-2"></i>Khóa học của tôi
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="my-tests">
                  <i class="bi bi-clipboard-check me-2"></i>Kết quả trắc nghiệm
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="my-consultations">
                  <i class="bi bi-calendar-event me-2"></i>Lịch tư vấn
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="payment-history">
                  <i class="bi bi-credit-card me-2"></i>Lịch sử thanh toán
                </a>
              </li>
              <li><hr class="dropdown-divider"></li>
              <li>
                <a class="dropdown-item" href="#" id="logout-btn">
                  <i class="bi bi-box-arrow-right me-2"></i>Đăng xuất
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
      
      <!-- Cart button -->
      <a href="cart" class="cart-btn">
        <i class="bi bi-cart-fill"></i>
        <span class="cart-count" id="header-cart-count">0</span>
      </a>
    </div>
  </div>
</div>

<!-- Main Header -->
<header id="header" class="header d-flex align-items-center fixed-top">
  <div class="container position-relative d-flex align-items-center justify-content-between">

    <a href="home" class="logo d-flex align-items-center me-auto me-xl-0">
      <img src="assets/img/logo.png" alt="Logo">
      <h1 class="sitename">
        UNLOCK<br>
        YOUR <span>CAREER</span><br>
        <small>BEST FIT MATTERS</small>
      </h1>
    </a>

    <nav id="navmenu" class="navmenu">
      <ul>
        <li class="dropdown">
          <a href="su-menh-tam-nhin">
            <span>VỀ UNLOCK YOUR CAREER</span> 
            <i class="bi bi-chevron-down toggle-dropdown"></i>
          </a>
          <ul>
            <li><a href="su-menh-tam-nhin">SỨ MỆNH VÀ TẦM NHÌN</a></li>
            <li><a href="mo-hinh-danh-gia">MÔ HÌNH ĐÁNH GIÁ</a></li>
            <li><a href="doi-ngu-co-van">ĐỘI NGŨ CỐ VẤN</a></li>
          </ul>
        </li>
        <li class="dropdown">
          <a href="huongnghiep">
            <span>GIẢI PHÁP</span> 
            <i class="bi bi-chevron-down toggle-dropdown"></i>
          </a>
          <ul>
            <li><a href="huongnghiep">Hướng nghiệp</a></li>
            <li><a href="khoahoc">Khóa học</a></li>
          </ul>
        </li>
        <li><a href="nguon-du-lieu">NGUỒN DỮ LIỆU</a></li>
      </ul>
      <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
    </nav>

  </div>
</header>

<!-- Mobile Navigation Menu (chỉ hiện trên mobile/tablet) -->
<nav id="mobile-nav" class="mobile-nav d-xl-none">
  <div class="mobile-nav-content">
    <div class="mobile-nav-header">
      <img src="assets/img/logo.png" alt="Logo" class="mobile-logo">
      <button class="mobile-nav-close">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <ul class="mobile-nav-menu">
      <li class="mobile-dropdown">
        <a href="ve-unlock-your-career" class="mobile-dropdown-toggle">
          <span>VỀ UNLOCK YOUR CAREER</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <ul class="mobile-submenu">
          <li><a href="su-menh-tam-nhin">SỨ MỆNH VÀ TẦM NHÌN</a></li>
          <li><a href="mo-hinh-danh-gia">MÔ HÌNH ĐÁNH GIÁ</a></li>
          <li><a href="doi-ngu-co-van">ĐỘI NGŨ CỐ VẤN</a></li>
        </ul>
      </li>
      <li class="mobile-dropdown">
        <a href="giai-phap" class="mobile-dropdown-toggle">
          <span>GIẢI PHÁP</span>
          <i class="bi bi-chevron-down"></i>
        </a>
        <ul class="mobile-submenu">
          <li><a href="huongnghiep">Hướng nghiệp</a></li>
          <li><a href="khoahoc">Khóa học</a></li>
        </ul>
      </li>
      <li><a href="nguon-du-lieu">NGUỒN DỮ LIỆU</a></li>
    </ul>
  </div>
</nav>

<!-- Mobile Nav Overlay -->
<div id="mobile-nav-overlay" class="mobile-nav-overlay d-xl-none"></div>

<!-- Header Authentication Script -->
<script>
  // Header Authentication Manager
  class HeaderAuth {
    constructor() {
      this.notLoggedInElement = document.getElementById('auth-not-logged-in');
      this.loggedInElement = document.getElementById('auth-logged-in');
      this.userDisplayName = document.getElementById('user-display-name');
      this.logoutBtn = document.getElementById('logout-btn');
      
      this.init();
    }
    
    init() {
      // Check authentication status on load
      this.checkAuthStatus();
      
      // Set up logout button
      if (this.logoutBtn) {
        this.logoutBtn.addEventListener('click', (e) => {
          e.preventDefault();
          this.handleLogout();
        });
      }
      
      // Listen for auth state changes from other components
      window.addEventListener('authStateChanged', (e) => {
        this.updateAuthDisplay(e.detail);
      });
    }
    
    checkAuthStatus() {
      // Try to use authChecker if available
      if (typeof authChecker !== 'undefined') {
        try {
          const authStatus = authChecker.getCurrentAuthStatus();
          if (authStatus.isAuthenticated && authStatus.user) {
            this.showAuthenticatedState(authStatus.user);
            return;
          }
        } catch (error) {
          console.error('[Header Auth] Error using authChecker:', error);
        }
      }
      
      // Fallback to cookie check
      const userInfo = this.getUserInfoFromCookie();
      
      if (userInfo && userInfo.id) {
        this.showAuthenticatedState(userInfo);
      } else {
        this.showNotAuthenticatedState();
      }
    }
    
    getUserInfoFromCookie() {
      try {
        const userInfoCookie = this.getCookie('pac_user_info');
        if (userInfoCookie) {
          return JSON.parse(decodeURIComponent(userInfoCookie));
        }
      } catch (error) {
        console.error('[Header Auth] Error parsing user info cookie:', error);
      }
      return null;
    }
    
    getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(';').shift();
      }
      return null;
    }
    
    showAuthenticatedState(userInfo) {
      if (!this.notLoggedInElement || !this.loggedInElement) return;
      
      // Update user display name
      if (this.userDisplayName) {
        const displayName = userInfo.fullname || userInfo.username || 'Người dùng';
        this.userDisplayName.textContent = displayName;
      }
      
      // Hide not logged in state
      this.notLoggedInElement.style.display = 'none';
      
      // Show logged in state
      this.loggedInElement.style.display = 'block';
    }
    
    showNotAuthenticatedState() {
      if (!this.notLoggedInElement || !this.loggedInElement) return;
      
      // Hide logged in state
      this.loggedInElement.style.display = 'none';
      
      // Show not logged in state
      this.notLoggedInElement.style.display = 'block';
    }
    
    updateAuthDisplay(authData) {
      if (authData && authData.isAuthenticated) {
        this.showAuthenticatedState(authData.user);
      } else {
        this.showNotAuthenticatedState();
      }
    }
    
    async handleLogout() {
      try {
        // Check if authChecker is available (from main authentication system)
        if (typeof authChecker !== 'undefined') {
          await authChecker.logout(true);
        } else {
          // Fallback logout implementation
          await this.fallbackLogout();
        }
        
      } catch (error) {
        console.error('[Header Auth] Logout error:', error);
        // Still redirect on error to ensure logout
        window.location.href = 'dangnhap';
      }
    }
    
    async fallbackLogout() {
      // Direct API call to logout
      const response = await fetch('api/auth/logout.php', {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        // Clear local auth state
        this.showNotAuthenticatedState();
        
        // Redirect to login
        window.location.href = 'dangnhap';
      } else {
        throw new Error('Logout failed');
      }
    }
  }
  
  // Initialize header auth when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    // Wait a bit for other scripts to load
    setTimeout(() => {
      if (!window.headerAuth) {
        window.headerAuth = new HeaderAuth();
      }
    }, 100);
  });
  
  // Re-initialize if header is loaded dynamically  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(() => {
        if (!window.headerAuth) {
          window.headerAuth = new HeaderAuth();
        }
      }, 100);
    });
  } else {
    // DOM already loaded, initialize immediately
    setTimeout(() => {
      if (!window.headerAuth) {
        window.headerAuth = new HeaderAuth();
      }
    }, 100);
  }

  // Make HeaderAuth available globally for manual refresh
  window.refreshHeaderAuth = function() {
    if (window.headerAuth) {
      window.headerAuth.checkAuthStatus();
    }
  };
</script>

<!-- Header Cart Management Script -->
<script src="assets/js/header-cart.js"></script>
